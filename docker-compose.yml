version: '3.8'

services:
  ticktick-mcp:
    build: .
    container_name: ticktick-mcp-server
    # Expose internal port for reverse proxy routing
    ports:
      - "8080:8080"
    environment:
      # TickTick API credentials (supply via .env or external secret injection)
      - TICKTICK_CLIENT_ID=${TICKTICK_CLIENT_ID}
      - TICKTICK_CLIENT_SECRET=${TICKTICK_CLIENT_SECRET}
      - TICKTICK_ACCESS_TOKEN=${TICKTICK_ACCESS_TOKEN}
      - TICKTICK_REFRESH_TOKEN=${TICKTICK_REFRESH_TOKEN}
      # Optional overrides (Dida365, etc.)
      - TICKTICK_BASE_URL=${TICKTICK_BASE_URL:-https://api.ticktick.com/open/v1}
      - TICKTICK_AUTH_URL=${TICKTICK_AUTH_URL:-https://ticktick.com/oauth/authorize}
      - TICKTICK_TOKEN_URL=${TICKTICK_TOKEN_URL:-https://ticktick.com/oauth/token}
      # OAuth2 gateway configuration (for Claude Desktop remote connector auth)
      - MCP_OAUTH_CLIENTS=${MCP_OAUTH_CLIENTS}
      - MCP_OAUTH_SIGNING_KEY=${MCP_OAUTH_SIGNING_KEY}
      - MCP_TOKEN_EXPIRY=${MCP_TOKEN_EXPIRY:-900}
      - FASTMCP_SERVER_URL=${FASTMCP_SERVER_URL:-http://127.0.0.1:8000}
      # Reverse proxy integration (nginx-proxy / jwilder / traefik style)
      - VIRTUAL_HOST=ticktick.marcuslab.uk
      - VIRTUAL_PORT=8080
      - LETSENCRYPT_HOST=ticktick.marcuslab.uk
      - LETSENCRYPT_EMAIL=marcus.williams13@gmail.com
      # Optional logging level
      - LOG_LEVEL=INFO
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/sse')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    # Use an env_file for local dev, override with secrets in prod
    env_file:
      - .env
    # Uncomment to mount .env read-only instead of env_file
    # volumes:
    #   - ./.env:/app/.env:ro
    networks:
      - portpilot_default
      - ticktick_internal

    # Security options (non-root user can be set in Dockerfile build stage if desired)
    # user: 1000:1000
    # Read-only root FS except needed dirs (adjust if app writes elsewhere)
    # read_only: true
    # tmpfs:
    #   - /tmp

networks:
  portpilot_default:
    external: true
  ticktick_internal:
    driver: bridge

# Optional secrets section (if upgrading to compose v3.9 with swarm or using bind mounts)
# secrets:
#   mcp_api_keys:
#     file: ./secrets/mcp_api_keys

# Example secrets file content (not committed):
# echo "MCP_SERVER_API_KEYS=$(python - <<'PY'\nimport secrets;print(','.join(secrets.token_urlsafe(32) for _ in range(2)))\nPY)" > ./secrets/mcp_api_keys

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    container_name: ticktick-oauth2-proxy
    restart: unless-stopped
    ports:
      - "8081:8081"  # External authenticated entrypoint
    environment:
      - OAUTH2_PROXY_PROVIDER=oidc
      - OAUTH2_PROXY_UPSTREAMS=http://ticktick-mcp:8080/sse
      - OAUTH2_PROXY_HTTP_ADDRESS=0.0.0.0:8081
      - OAUTH2_PROXY_REDIRECT_URL=${OIDC_REDIRECT_URL:-https://ticktick.marcuslab.uk/oauth2/callback}
      - OAUTH2_PROXY_CLIENT_ID=${OIDC_CLIENT_ID}
      - OAUTH2_PROXY_CLIENT_SECRET=${OIDC_CLIENT_SECRET}
      - OAUTH2_PROXY_OIDC_ISSUER_URL=${OIDC_ISSUER_URL}
      - OAUTH2_PROXY_COOKIE_SECRET=${OAUTH2_PROXY_COOKIE_SECRET}
      - OAUTH2_PROXY_EMAIL_DOMAINS=*
      - OAUTH2_PROXY_SCOPE=openid profile email
      - OAUTH2_PROXY_SET_XAUTHREQUEST=true
      - OAUTH2_PROXY_PASS_ACCESS_TOKEN=true
      - VIRTUAL_HOST=ticktick.marcuslab.uk
      - VIRTUAL_PORT=8081
      - LETSENCRYPT_HOST=ticktick.marcuslab.uk
      - LETSENCRYPT_EMAIL=marcus.williams13@gmail.com
    networks:
      - portpilot_default
      - ticktick_internal
    depends_on:
      - ticktick-mcp
